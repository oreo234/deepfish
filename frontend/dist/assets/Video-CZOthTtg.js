import{f as e}from"./index-proxR6sI.js";import{_ as s,a as t,f as a,w as i,r as d,E as r,o,b as l,k as n,l as c,h as m,F as h,g as v,j as u}from"./index-rHRo5HIh.js";const p={class:"video-page"},f={class:"card-header"},g={class:"content"},L={class:"left"},w={class:"upload-box"},b={key:0,class:"preview-box"},R=["src"],U={class:"right"},k={class:"result-item"},_={class:"thumb"},y=["src"],x={class:"info"},F={class:"class"},C={class:"conf"},D={class:"model"},E={class:"time"};const j=s({name:"VideoRecognition",data:()=>({videoUrl:"",videoLoaded:!1,processing:!1,frameResults:[],frameIntervalSec:1,maxFrames:8,_timer:null}),methods:{handleVideoChange(e){if(!e||!e.raw)return;const s=e.raw,t=URL.createObjectURL(s);this.videoUrl=t,this.videoLoaded=!1,this.frameResults=[],this.$nextTick(()=>{const e=this.$refs.videoEl;e&&e.load()})},onLoaded(){this.videoLoaded=!0},startDetect(){if(!this.videoLoaded)return void r.warning("请先选择并加载视频");if(this.processing)return;this.processing=!0,this.frameResults=[];const s=this.$refs.videoEl,t=Math.floor(s.duration),a=document.createElement("canvas"),i=a.getContext("2d");a.width=s.videoWidth||640,a.height=s.videoHeight||360;let d=0,o=0;const l=async()=>{if(this.processing){if(d>=this.maxFrames||o>t)return this.processing=!1,void r.success("识别完成");try{s.currentTime=o,await this.waitForFrameRender(s),i.drawImage(s,0,0,a.width,a.height);const t=a.toDataURL("image/png"),r=t.split(",")[1],n=await e.predict(r);this.frameResults.push({timeLabel:`t = ${o}s`,frameDataUrl:t,result:n}),d+=1,o+=this.frameIntervalSec,setTimeout(l,300)}catch(n){r.error("识别发生错误"),this.processing=!1}}};l()},stopDetect(){this.processing=!1},waitForFrameRender:e=>new Promise(s=>{const t=()=>{e.removeEventListener("seeked",t),s()};e.addEventListener("seeked",t)})},beforeUnmount(){this.videoUrl&&URL.revokeObjectURL(this.videoUrl),this.processing=!1}},[["render",function(e,s,r,j,I,$){const T=d("el-button"),V=d("el-upload"),O=d("el-empty"),S=d("el-timeline-item"),H=d("el-timeline"),M=d("el-card");return o(),t("div",p,[a(M,{class:"card",shadow:"never"},{header:i(()=>[l("div",f,[s[3]||(s[3]=l("span",null,"视频识别",-1)),a(T,{type:"primary",disabled:!I.videoLoaded||I.processing,onClick:$.startDetect},{default:i(()=>[...s[1]||(s[1]=[c("开始识别",-1)])]),_:1},8,["disabled","onClick"]),a(T,{type:"danger",disabled:!I.processing,onClick:$.stopDetect},{default:i(()=>[...s[2]||(s[2]=[c("停止识别",-1)])]),_:1},8,["disabled","onClick"])])]),default:i(()=>[l("div",g,[l("div",L,[l("div",w,[a(V,{class:"upload",action:"","auto-upload":!1,"show-file-list":!1,accept:"video/*","on-change":$.handleVideoChange},{default:i(()=>[a(T,{type:"primary"},{default:i(()=>[...s[4]||(s[4]=[c("选择视频文件",-1)])]),_:1})]),_:1},8,["on-change"]),s[5]||(s[5]=l("div",{class:"tips"},"支持 mp4 等常见视频格式，识别过程将抽取关键帧进行检测",-1))]),I.videoUrl?(o(),t("div",b,[l("video",{ref:"videoEl",src:I.videoUrl,controls:"",onLoadedmetadata:s[0]||(s[0]=(...e)=>$.onLoaded&&$.onLoaded(...e)),class:"preview-video"},null,40,R)])):n("",!0)]),l("div",U,[a(M,{shadow:"hover",class:"results-card"},{header:i(()=>[...s[6]||(s[6]=[l("div",{class:"card-header"},[l("span",null,"识别结果（逐帧）")],-1)])]),default:i(()=>[0===I.frameResults.length?(o(),m(O,{key:0,description:"尚未开始识别或无结果"})):(o(),m(H,{key:1},{default:i(()=>[(o(!0),t(h,null,v(I.frameResults,(e,s)=>(o(),m(S,{key:s,timestamp:e.timeLabel,placement:"top"},{default:i(()=>[l("div",k,[l("div",_,[l("img",{src:e.frameDataUrl,alt:"frame"},null,8,y)]),l("div",x,[l("div",F,"类别："+u(e.result.class),1),l("div",C,"置信度："+u((100*e.result.confidence).toFixed(1))+"%",1),l("div",D,"模型："+u(e.result.model),1),l("div",E,"推理耗时："+u(e.result.inference_time)+"s",1)])])]),_:2},1032,["timestamp"]))),128))]),_:1}))]),_:1})])])]),_:1})])}],["__scopeId","data-v-01f82d6b"]]);export{j as default};
